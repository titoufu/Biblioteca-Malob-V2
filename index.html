<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Biblioteca Malob</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      padding: 20px;
    }
    .table-responsive {
      margin-top: 20px;
    }
    .progress {
      height: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">Catálogo de Livros</h1>

    <!-- Novo seletor de tipo de busca -->
    <div class="row mb-3">
      <div class="col-md-4">
        <select id="filtroTipo" class="form-select">
          <option value="TITULO">Buscar por TÍTULO</option>
          <option value="AUTOR">Buscar por AUTOR</option>
        </select>
      </div>
      <div class="col-md-8">
        <input type="text" id="searchInput" class="form-control" placeholder="Digite para buscar..." oninput="buscarLivro()" />
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Título</th>
            <th>Autor</th>
            <th class="text-center">Armário</th>
            <th class="text-center">Prateleira</th>
          </tr>
        </thead>
        <tbody id="resultados"></tbody>
      </table>
    </div>

    <!-- Gauge de posição do livro -->
    <div id="gaugeContainer" class="mt-5 d-none">
      <h5 class="text-center">Posição do Livro na Prateleira</h5>
      <div class="progress">
        <div id="gaugeBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
          aria-valuemin="0" aria-valuemax="100">0%</div>
      </div>
      <p class="text-center mt-2" id="gaugeLabel"></p>
    </div>
  </div>

  <script>
    let livros = [];

    async function carregarCSV() {
      const response = await fetch('https://titoufu.github.io/Biblioteca-Malob-V2/livros.csv');
      const texto = await response.text();
      const linhas = texto.trim().split('\n');
      const cabecalhos = linhas[0].split(',');
      livros = linhas.slice(1).map(linha => {
        const colunas = linha.split(',');
        const livro = {};
        cabecalhos.forEach((chave, i) => {
          livro[chave.trim()] = colunas[i]?.trim() ?? '';
        });
        return livro;
      });

      buscarLivro(); // mostra todos os livros ordenados ao carregar
    }

    function buscarLivro() {
      const termo = document.getElementById('searchInput').value.toLowerCase();
      const tipo = document.getElementById('filtroTipo').value;

      const resultados = termo === ""
        ? livros.slice().sort((a, b) => a.TITULO.localeCompare(b.TITULO))
        : livros.filter(livro =>
            livro[tipo]?.toLowerCase().includes(termo)
          );

      displayResults(resultados);
    }

    function displayResults(lista) {
      const tabela = document.getElementById('resultados');
      tabela.innerHTML = '';

      if (lista.length === 0) {
        tabela.innerHTML = `<tr><td colspan="4" class="text-center">Nenhum livro encontrado.</td></tr>`;
        document.getElementById('gaugeContainer').classList.add('d-none');
        return;
      }

      for (const livro of lista) {
        const linha = document.createElement('tr');
        linha.innerHTML = `
          <td data-label="Título">${escapeHtml(livro.TITULO)}</td>
          <td data-label="Autor">${escapeHtml(livro.AUTOR)}</td>
          <td data-label="Armário" class="text-center">${escapeHtml(livro.ARMARIO)}</td>
          <td data-label="Prateleira" class="text-center">${escapeHtml(livro.PRATILEIRA)}</td>
        `;
        linha.onclick = () => mostrarGauge(livro.TITULO, livro.ARMARIO, livro.PRATILEIRA);
        tabela.appendChild(linha);
      }
    }

    function mostrarGauge(titulo, armario, prateleira) {
      const livrosNaPrateleira = livros.filter(l =>
        l.ARMARIO === armario && l.PRATILEIRA === prateleira
      ).sort((a, b) => a.TITULO.localeCompare(b.TITULO));

      const posicao = livrosNaPrateleira.findIndex(l => l.TITULO === titulo) + 1;
      const total = livrosNaPrateleira.length;
      const percentual = Math.round((posicao / total) * 100);

      const gauge = document.getElementById('gaugeContainer');
      const barra = document.getElementById('gaugeBar');
      const label = document.getElementById('gaugeLabel');

      barra.style.width = `${percentual}%`;
      barra.setAttribute('aria-valuenow', percentual);
      barra.textContent = `${percentual}%`;
      label.textContent = `O livro "${titulo}" está na posição ${posicao} de ${total} na prateleira ${prateleira}, armário ${armario}.`;

      gauge.classList.remove('d-none');
    }

    function escapeHtml(text) {
      return text?.replace(/[&<>"']/g, match => {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return map[match];
      }) ?? '';
    }

    carregarCSV();
  </script>
</body>
</html>
