<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Biblioteca</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .hidden { display: none !important; }
    .search-container { max-width: 900px; margin: 0 auto; }
    .table-responsive { margin-top: 20px; }
    @media (max-width: 576px) {
      .table thead { display: none; }
      .table tr { display: block; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; padding: 10px; }
      .table td { display: block; text-align: left !important; font-size: 14px; border: none; padding: 5px 0; }
      .table td::before { content: attr(data-label); font-weight: bold; display: inline-block; width: 100px; }
    }
  </style>
</head>
<body>
  <!-- Interface mantida igual -->
  <div id="telaInicial" class="text-center">
    <h2>Biblioteca Lar Esp√≠rita Maria Lobato de Freitas</h2>
    <p class="mt-4">Como deseja realizar a consulta?</p>
    <div class="d-grid gap-3 col-6 mx-auto mt-3">
      <button onclick="iniciarBusca('TITULO')" class="btn btn-primary btn-lg">üîç Consultar por T√çTULO</button>
      <button onclick="iniciarBusca('AUTOR')" class="btn btn-secondary btn-lg">üîç Consultar por AUTOR</button>
    </div>
  </div>

  <div id="telaBusca" class="search-container hidden">
    <div class="text-center mb-4">
      <h2 id="tituloBusca">Consulta</h2>
      <button onclick="voltarInicio()" class="btn btn-link btn-sm">‚Üê Voltar ao in√≠cio</button>
    </div>

    <div class="input-group mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Digite para buscar...">
      <button class="btn btn-primary" type="button" onclick="searchBooks()">Buscar</button>
      <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">Limpar</button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="table-light">
          <tr>
            <th>T√≠tulo</th>
            <th>Autor</th>
            <th class="text-center">Arm√°rio</th>
            <th class="text-center">Prateleira</th>
            <th class="text-center">Posi√ß√£o</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <tr><td colspan="5" class="text-center">Carregando dados...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="mt-3 text-muted text-center small">
      Total de livros encontrados: <span id="totalCount">0</span>
    </div>
  </div>

<script>
const CSV_URL = 'https://raw.githubusercontent.com/titoufu/Biblioteca-Malob/main/livros.csv';
let livros = [];
let campoBusca = 'TITULO';

async function carregarDados() {
  try {
    // Etapa 1: Baixar o CSV como texto puro
    const response = await fetch(CSV_URL);
    if (!response.ok) throw new Error(`Erro HTTP! status: ${response.status}`);
    
    // Etapa 2: Processar manualmente o texto
    const csvText = await response.text();
    console.log('Tamanho do arquivo:', csvText.length, 'caracteres');
    
    // Etapa 3: Corre√ß√£o pr√©via de problemas no CSV
    const csvCorrigido = corrigirCSV(csvText);
    
    // Etapa 4: Processar linha por linha com tratamento robusto
    livros = processarCSV(csvCorrigido);
    
    console.log('Total de livros carregados:', livros.length);
    
    // Verifica√ß√£o final
    const armarios = {};
    livros.forEach(livro => {
      const armario = livro.ARMARIO || 'Sem arm√°rio';
      armarios[armario] = (armarios[armario] || 0) + 1;
    });
    console.log('Distribui√ß√£o por arm√°rio:', armarios);
    
    if (Object.keys(armarios).length < 7) {
      console.warn('Aviso: Nem todos os arm√°rios foram carregados!');
      // Tentativa alternativa de carregamento
      await tentativaAlternativa();
      return;
    }
    
    livros.sort((a, b) => (a.TITULO || '').localeCompare(b.TITULO || ''));
    searchBooks();
    
  } catch (err) {
    console.error('Erro cr√≠tico:', err);
    document.getElementById('resultsBody').innerHTML = `
      <tr><td colspan="5" class="text-center text-danger">
        Erro grave ao carregar dados. Tente recarregar a p√°gina.<br>
        Detalhes: ${err.message}
      </td></tr>`;
  }
}

// Fun√ß√£o para corrigir problemas conhecidos no CSV
function corrigirCSV(csvText) {
  // 1. Corrigir quebras de linha dentro de campos entre aspas
  let dentroDeAspas = false;
  let resultado = '';
  
  for (let i = 0; i < csvText.length; i++) {
    const char = csvText[i];
    
    if (char === '"') {
      dentroDeAspas = !dentroDeAspas;
      resultado += char;
    } else if (char === '\n' && dentroDeAspas) {
      resultado += ' '; // Substitui quebra de linha por espa√ßo
    } else {
      resultado += char;
    }
  }
  
  // 2. Garantir que a √∫ltima linha termine com quebra de linha
  if (!resultado.endsWith('\n')) {
    resultado += '\n';
  }
  
  return resultado;
}

// Processador CSV ultra robusto
function processarCSV(csvText) {
  const linhas = csvText.split(/\r?\n/);
  if (linhas.length < 2) return [];
  
  const cabecalhos = linhas[0].split(',').map(h => h.trim());
  const dados = [];
  
  let linhaAtual = [];
  let campoAtual = '';
  let dentroDeAspas = false;
  
  for (let i = 1; i < linhas.length; i++) {
    const linha = linhas[i].trim();
    if (!linha) continue;
    
    for (let j = 0; j < linha.length; j++) {
      const char = linha[j];
      
      if (char === '"') {
        if (linha[j+1] === '"') {
          campoAtual += '"';
          j++;
        } else {
          dentroDeAspas = !dentroDeAspas;
        }
      } else if (char === ',' && !dentroDeAspas) {
        linhaAtual.push(campoAtual.trim());
        campoAtual = '';
      } else {
        campoAtual += char;
      }
    }
    
    if (!dentroDeAspas) {
      linhaAtual.push(campoAtual.trim());
      if (linhaAtual.length === cabecalhos.length) {
        const livro = {};
        cabecalhos.forEach((cabecalho, index) => {
          livro[cabecalho] = linhaAtual[index] || '';
        });
        dados.push(livro);
      } else {
        console.warn('Linha ignorada - n√∫mero incorreto de colunas:', linhaAtual);
      }
      linhaAtual = [];
      campoAtual = '';
    } else {
      campoAtual += '\n'; // Mant√©m quebras de linha internas
    }
  }
  
  return dados;
}

// M√©todo alternativo como fallback
async function tentativaAlternativa() {
  try {
    console.log('Tentando m√©todo alternativo de carregamento...');
    
    // Carrega o CSV linha por linha via API GitHub
    const response = await fetch(`https://api.github.com/repos/titoufu/Biblioteca-Malob/contents/livros.csv`);
    const data = await response.json();
    const csvContent = atob(data.content);
    
    // Processa novamente
    livros = processarCSV(csvContent);
    console.log('Total de livros (m√©todo alternativo):', livros.length);
    
    const armarios = {};
    livros.forEach(livro => {
      const armario = livro.ARMARIO || 'Sem arm√°rio';
      armarios[armario] = (armarios[armario] || 0) + 1;
    });
    console.log('Distribui√ß√£o por arm√°rio (alternativo):', armarios);
    
    livros.sort((a, b) => (a.TITULO || '').localeCompare(b.TITULO || ''));
    searchBooks();
    
  } catch (err) {
    console.error('Falha no m√©todo alternativo:', err);
    document.getElementById('resultsBody').innerHTML = `
      <tr><td colspan="5" class="text-center text-danger">
        N√£o foi poss√≠vel carregar todos os dados. Contate o administrador.
      </td></tr>`;
  }
}

// Restante do c√≥digo mantido igual...
function iniciarBusca(campo) {
  campoBusca = campo;
  document.getElementById('telaInicial').classList.add('hidden');
  document.getElementById('telaBusca').classList.remove('hidden');
  document.getElementById('tituloBusca').textContent = `Consulta por ${campo === 'TITULO' ? 'T√çTULO' : 'AUTOR'}`;
  carregarDados();
}

function voltarInicio() {
  document.getElementById('telaBusca').classList.add('hidden');
  document.getElementById('telaInicial').classList.remove('hidden');
  document.getElementById('searchInput').value = '';
}

function searchBooks() {
  const termo = document.getElementById('searchInput').value.toLowerCase();
  const filtrados = termo === ''
    ? livros.slice().sort((a, b) => (a.TITULO || '').localeCompare(b.TITULO || ''))
    : livros.filter(l => (l[campoBusca] || '').toLowerCase().includes(termo));
  
  console.log('Livros filtrados:', filtrados.length);
  displayResults(filtrados);
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchBooks();
}

function displayResults(results) {
  const tbody = document.getElementById('resultsBody');
  const countSpan = document.getElementById('totalCount');

  if (!results.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum livro encontrado</td></tr>';
    countSpan.textContent = '0';
    return;
  }

  let html = '';
  results.forEach(livro => {
    const armario = (livro.ARMARIO || '').trim();
    const prateleira = (livro.PRATILEIRA || '').trim();
    const titulo = (livro.TITULO || '').trim();
    const chaveGrupo = `${armario}-${prateleira}`;

    const mesmosLugar = livros
      .filter(l =>
        `${(l.ARMARIO || '').trim()}-${(l.PRATILEIRA || '').trim()}` === chaveGrupo
      )
      .sort((a, b) => (a.TITULO || '').localeCompare(b.TITULO || ''));

    const posicao = mesmosLugar.findIndex(l => (l.TITULO || '').trim() === titulo) + 1;
    const total = mesmosLugar.length;
    const gaugeMax = 60;
    const percent = Math.min(100, (posicao / gaugeMax * 100).toFixed(1));

    html += `
      <tr>
        <td data-label="T√≠tulo">${escapeHtml(livro.TITULO)}</td>
        <td data-label="Autor">${escapeHtml(livro.AUTOR)}</td>
        <td data-label="Arm√°rio" class="text-center">${escapeHtml(livro.ARMARIO)}</td>
        <td data-label="Prateleira" class="text-center">${escapeHtml(livro.PRATILEIRA)}</td>
        <td data-label="Posi√ß√£o" style="min-width: 160px;">
          <div class="progress" style="height: 20px; border: 1px solid black;">
            <div class="progress-bar bg-success" role="progressbar"
                style="width: ${percent}%" aria-valuenow="${posicao}" aria-valuemin="0" aria-valuemax="${gaugeMax}">
            </div>
          </div>
          <div style="font-size: 0.9em; margin-top: 4px;">üìö Livro ${posicao} de ${total}</div>
        </td>
      </tr>`;
  });

  tbody.innerHTML = html;
  countSpan.textContent = results.length;
}

function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text?.replace(/[&<>"']/g, m => map[m]) || '';
}
</script>
</body>
</html>